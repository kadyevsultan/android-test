name: Android 3-Emulator Check

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  check-emulators:
    runs-on: ubuntu-latest

    steps:
      # 1. Клонируем репозиторий
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Устанавливаем Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      # 3. Устанавливаем adb
      - name: Install ADB
        run: |
          sudo apt-get update
          sudo apt-get install -y android-tools-adb

      # 4. Запускаем 3 эмулятора
      - name: Start 3 emulators
        run: docker compose up -d emulator1 emulator2 emulator3

      # 5. Ждём, пока все эмуляторы станут доступными через adb
      - name: Wait for emulators
        run: |
          EMULATORS=("5555" "5556" "5557")
          for PORT in "${EMULATORS[@]}"; do
            echo "Waiting for emulator on port $PORT..."
            timeout=120
            until adb connect localhost:$PORT | grep -q "connected"; do
              sleep 5
              timeout=$((timeout-5))
              if [ $timeout -le 0 ]; then
                echo "Emulator on port $PORT failed to start"
                exit 1
              fi
            done
            echo "Emulator on port $PORT is running ✅"
          done

      # 6. Проверяем статус контейнеров
      - name: Verify containers
        run: |
          for NAME in emulator1 emulator2 emulator3; do
            if ! docker ps --filter "name=$NAME" --filter "status=running" | grep -q $NAME; then
              echo "$NAME container is not running!"
              exit 1
            else
              echo "$NAME container is running ✅"
            fi
          done

      # 7. Проверка базовой производительности (CPU/RAM) каждого эмулятора
      - name: Check emulators performance
        run: |
          for NAME in emulator1 emulator2 emulator3; do
            echo "=== Performance for $NAME ==="
            docker stats --no-stream $NAME
          done

      # 8. Очистка после теста
      - name: Tear down
        run: docker compose down
